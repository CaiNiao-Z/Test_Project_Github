# 按键(Key)学习笔记

几乎每个开发板都会板载有独立按键，因为按键用处很多。常态下，独立按键是断开的，按下的时候才闭合。每个独立按键会单独占用一个 IO 口，通过 IO 口的高低电平判断按键的状态。但是按键在闭合和断开的时候，都存在抖动现象，即按键在闭合时不会马上就稳定的连接，断开时也不会马上断开。这是机械触点，无法避免。独立按键抖动波形图如下：

![1.按键抖动](C:\Users\30832\Desktop\STM32F407ZGT6\STM32Project\3.按键(Key)学习笔记\image\1.按键抖动.png)

图中的按下抖动和释放抖动的时间一般为 5~10ms，如果在抖动阶段采样，其不稳定状态可能出现一次按键动作被认为是多次按下的情况。为了避免抖动可能带来的误操作，我们要做的措施就是给按键消抖（即采样稳定闭合阶段）。消抖方法分为硬件消抖和软件消抖。

硬件消抖：利用 RC 电路的电容充放电特性来对抖动产生的电压毛刺进行平滑出来，从而实现消抖。

![2.硬件消抖电路图](C:\Users\30832\Desktop\STM32F407ZGT6\STM32Project\3.按键(Key)学习笔记\image\2.硬件消抖电路图.png)

软件消抖：方法很多，我们例程中使用最简单的延时消抖。检测到按键按下后，一般进行10ms 延时，用于跳过抖动的时间段，如果消抖效果不好可以调整这个 10ms 延时，因为不同类型的按键抖动时间可能有偏差。待延时过后再检测按键状态，如果没有按下，那我们就判断这是抖动或者干扰造成的；如果还是按下，那么我们就认为这是按键真的按下了。对按键释放的判断同理。

![image-20230605154341977](C:\Users\30832\Desktop\STM32F407ZGT6\STM32Project\3.按键(Key)学习笔记\image\3.按键电路图.png)

```C
/* 该函数支持连按模式设置 mode为0时不支持连按，mode为1时支持连按模式 */
uint8_t KeyScanf(uint8_t mode)
{
  static uint8_t key_up = 1;  /* 按键按松开标志 */
  uint8_t key_value=0;		/* 此处一定要记得给赋0值 */
  if(mode) key_up = 1;          /* 支持连按 */
  
  if(key_up && (KEY1 == 1 || KEY2 == 0 || KEY3 == 0 || KEY4 == 0))
  {
    HAL_Delay(10);
    key_up = 0;
    if(KEY1 == 1) key_value = KEY1_PRESS;
    if(KEY2 == 0) key_value = KEY2_PRESS;
    if(KEY3 == 0) key_value = KEY3_PRESS;
    if(KEY4 == 0) key_value = KEY4_PRESS;  
  }else if(KEY1 == 0 || KEY2 == 1 || KEY3 == 1 || KEY4 == 1)
  {
    /* 没有任何按键按下, 标记按键松开 */
    key_up = 1;
  }
  return key_value; //返回按键值
}
```

